---
# title: "The document title"
output:
  bookdown::pdf_document2:
    toc: false
    includes:
      in_header: "preamble.tex"
    latex_engine: lualatex
bibliography: bibliography.bib
csl: nlm.csl
---

```{r, setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, results = "hide", message = FALSE, warning = FALSE
)
```

```{r source}
library(here)
source(here("code", "02_explore.R"))
```

<!--
\begin{center}
Lucas Veras$^1$, Florêncio Diniz-Sousa$^1$, Giorjines Boppre$^1$, Vítor Devezas$^2$, Hugo Santos-Sousa$^2$, John Preto$^2$, João Paulo Vilas-Boas$^{3,4}$, Leandro Machado$^{3,4}$, José Oliveira$^1$, Hélder Fonseca$^1$
\end{center}

\bigskip

1 - Research Center in Physical Activity, Health and Leisure (CIAFEL), Faculty of Sport, University of Porto, Porto, Portugal

2 - General Surgery Department, São João Medical Center, Porto, Portugal

3 - Center of Research, Education, Innovation and Intervention in Sport (CIFI2D), Faculty of Sport, University of Porto, Porto, Portugal

4 - Biomechanics Laboratory (LABIOMEP-UP), University of Porto, Porto, Portugal
-->

\section*{Introduction}

The aim of this study was to develop pGRF and pLR prediction models based on accelerometer data during walking and running.

\section*{Methods}

\subsection*{Participants}

A convenience sample of `r max(sample_size$pGRF_N)` adults (`r unname(sample_size_sex["M"])` males; $`r sample_descriptives$age_mean`\pm`r sample_descriptives$age_sd`$ years; $`r sample_descriptives$height_mean`\pm`r sample_descriptives$height_sd`$ cm; $`r sample_descriptives$body_mass_mean`\pm`r sample_descriptives$body_mass_sd`$ kg; $`r sample_descriptives$BMI_mean`\pm`r sample_descriptives$BMI_sd`$ $\mathrm{kg\cdot m^{-2}}$, $\overline{X}\pm SD$) with no self-reported neurological or musculoskeletal limitations was recruited. Height and body mass were assessed following standard procedures with a stadiometer and a digital scale, respectively. All participants were informed about the experiments purpose and protocol before giving written informed consent. The study was approved by the local Ethics Committee (CES 192-14).

\subsection*{Protocol}

Data collection took place at Porto Biomechanics Laboratory (LABIOMEP-UP) in an instrumented treadmill with built-in FP (AMTI Corporation, Watertown, USA). Before starting the data collection, participants were given time to warm up on the treadmill. The protocol consisted of walking and running in 13 incremental speeds, with 0º inclination, from 2 to 14 $\mathrm{km\cdot h^{-1}}$ with 1 $\mathrm{km\cdot h^{-1}}$ increment. Walking and running speeds ranged from 2 to 6 $\mathrm{km\cdot h^{-1}}$ and from 7 to 14 $\mathrm{km\cdot h^{-1}}$, respectively. Each walking speed lasted for 1 minute and each running speed for 30 seconds. To ensure single foot contact on each FP during the trial, feedback regarding location on the treadmill was provided by a researcher. Participants wore their own sports shoes throughout the trials.

\medskip

During the protocol, participants wore three activity monitors, one at their right hip (along the anterior axillary line, at the level of the iliac crest), another at their lower back (at the midpoint between the two posterior superior iliac spines) and the last at their right ankle (immediately superior to the lateral malleolus). Activity monitors at waist level were secured on the same elastic belt with a clip and the activity monitor placed on the ankle was secured by an elastic belt fixed with adhesive tape. In all placements the accelerometer y-axis (vertical) was aligned with the standing body longitudinal axis. All participants wore the same three activity monitors always positioned at the same places.

\medskip

Activity monitors used were the GT9X Link model ($\mathrm{\pm16}$\textit{g} range; ActiGraph, Pensacola, USA) that incorporates primary and secondary triaxial accelerometers. As a manufacturer proprietary filter is applied on the primary, but not on the secondary accelerometer raw data, only data from the latter was used in this study, reducing filtering bias and enhancing the data processing replicability.

\medskip

Data from FP and accelerometers were collected at 1000 Hz and 100 Hz sampling frequency, respectively, and operated through the manufacturer supplied software (for the FP: Netforce, Version 3.5.1; AMTI Corporation, Watertown, USA; for the accelerometers: ActiLife version 6.13.3; Actigraph, Pensacola, USA). Raw GRF (expressed in N) and ACC (expressed in gravitational ACC units; 1\textit{g} = 9.807 $\mathrm{m\cdot s^{-2}}$) from the x, y and z vectors were exported to plain text files.

\subsection*{Data processing}

FP and accelerometer data were processed using MATLAB (Version 8.3, Mathworks, Natick, USA), as described elsewhere [@Veras2020]. Briefly, both GRF and ACC signals were filtered using a Butterworth fourth-order low-pass filter, with 20 Hz cut-off frequency, and their resultant vector calculated ($r_i = \sqrt{x_i^2 + y_i^2 + z_i^2}$). After that, peak ACC (pACC) values were defined as minimum height of twice the positive ACC average, during any given speed, and separated by 0.4 seconds minimum. GRF and ACC signals were adjusted through the time set by the systems clock, with manual correction based on visual inspection for possible errors, and then synchronized by the maximum cross-correlation coefficient. Peak GRF (pGRF) was determined as the highest value between 0.4 seconds before and after each pACC. The rates of change, LR for the GRF and ACC rate (AR) for the ACC, were computed through a second-order centered derivative from the beginning of the foot contact to the pGRF, and pLR and peak AR (pAR) were defined as the maximum value in the array.

\[f_i^{'} = \frac{f_{i + 1} - f_{i - 1}}{t_{i + 1} - t_{i - 1}}\]

\[f_{i_{max}}^{'} = max(f_i^{'})\]

Regions of interest for data analysis were manually selected where locomotion patterns were constant, which corresponded of 20-45 seconds periods, on average. Then, pGRF, pACC, pLR and pAR means of the resultant and its vertical component for each participant at each speed were extracted and used in all remaining analyses. In walking trials, a median of `r n_peaks_desc[which(n_peaks_desc$locomotion_type == "walking"), "n_peaks_median"]` peaks (interquartile range `r n_peaks_desc[which(n_peaks_desc$locomotion_type == "walking"), "n_peaks_median"] - n_peaks_desc[which(n_peaks_desc$locomotion_type == "walking"), "n_peaks_iqr"]`\textendash`r n_peaks_desc[which(n_peaks_desc$locomotion_type == "walking"), "n_peaks_median"] + n_peaks_desc[which(n_peaks_desc$locomotion_type == "walking"), "n_peaks_iqr"]`) were used to calculate these means, while in running trials it was a median of `r n_peaks_desc[which(n_peaks_desc$locomotion_type == "running"), "n_peaks_median"]` peaks (interquartile range `r n_peaks_desc[which(n_peaks_desc$locomotion_type == "running"), "n_peaks_median"] - n_peaks_desc[which(n_peaks_desc$locomotion_type == "running"), "n_peaks_iqr"]`\textendash`r n_peaks_desc[which(n_peaks_desc$locomotion_type == "running"), "n_peaks_median"] + n_peaks_desc[which(n_peaks_desc$locomotion_type == "running"), "n_peaks_iqr"]`).

\subsection*{Statistical analyses}

Statistical analyses were conducted using R statistical software (version `r paste(R.Version()$major, R.Version()$minor, sep = ".")`, R Foundation for Statistical Computing, Vienna, Austria). All statistical analyses were registered in an open platform, where R code utilized and detailed information can be assessed (LINK).

\medskip

Regression equations to predict pRGFR, pVGRF, pRLR and pVLR were developed by linear mixed models. Body mass (kg) was tested as a predictor in all models. In addition, in the pRGRF and pVGRF models, pRACC and peak vertical ACC (pVACC; \textit{g}), respectively, were tested as predictors, while in the pRLR and pVLR models, peak resultant ATR (pRATR; $g\phantom{ }\mathrm{\phantom{ }\cdot s^{-1}}$) and peak vertical ATR (pVATR; $g\phantom{ }\mathrm{\phantom{ }\cdot s^{-1}}$), respectively, were tested as predictors. All predictors were tested as fixed effects and were shown to be significant. Subject and speed were tested as random effects, and the inclusion of both has showed to improve the models. Final models were chosen according to -2 log-likelihood statistics [@Field2012]. Traditional coefficient of determination (R\textsuperscript{2}) was represented by conditional R\textsuperscript{2}, that estimates the variance explained by the whole model [@Nakagawa2013].

\medskip

Model was validated using the leave-one-out cross-validation approach [@Staudenmayer2012]. For leave-one-out cross-validation each participant’s data was separated into a testing dataset (one participant at a time) with the remaining data in the training dataset. New linear mixed models with the same outcomes and predictors as determined for the entire sample were developed using the training dataset and then used to predict the outcome for the participant in the testing dataset. This process was repeated for all participants (`r max(sample_size$pGRF_N)` times). Data from the testing dataset was used in the remaining statistical analysis.

\medskip

To assess the models prediction accuracy, mean absolute error (MAE), mean absolute percent error (MAPE) and root mean square error (RMSE) were calculated. Also, methods agreement was evaluated with Bland-Altman plots by plotting the difference between the actual (FP measured) and predicted values against their mean. Bias was computed as the mean of these differences and the limits of agreement were obtained using \pm 1.96 standard deviation of the mean between actual and predicted values [@Bland1986]. Linear regressions were applied to identify if the magnitude of the mean between actual and predicted values influenced the magnitude of their difference. This was done to ascertain if the prediction accuracy was constant throughout the assayed magnitude range [@Giavarina2015]. These analyses were conducted separately for data from each accelerometer placement and outcome.

\medskip

Finally, our pGRF prediction equation was compared with a previously published reference equation [@Neugebauer2014], that was developed using similar methods. This compaarison was performed in three ways using: i) the whole sample; ii) a subsample of walking trials; iii) a subsample of running trials. To assess the prediction accuracy, MAE, MAPE and RMSE were calculated using pVGRF values predicted from both equations. No pLR prediction equation suited to be compared with ours was found.

\medskip

\section*{Results}

```{r bmi_class}
BMI_avg <- sample_descriptives$BMI_mean
BMI_class <- NA
if (BMI_avg >= 18.5 & BMI_avg < 25) {
  BMI_class <- "normal weight"
} else if (BMI_avg >= 25 & BMI_avg < 30) {
  BMI_class <- "overweight"
} else if (BMI_avg >= 30 & BMI_avg < 35) {
  BMI_class <- "obesity class I"
} else if (BMI_avg >= 35 & BMI_avg < 40) {
  BMI_class <- "obesity class II"
} else if (BMI_avg >= 40) {
  BMI_class <- "obesity class III"
}
```
Our recruited sample presented an average BMI of `r sample_descriptives$BMI_mean` $\mathrm{kg\cdot m^{-2}}$, which is relatively high and classified as `r BMI_class`. 
It would be expected that participants with higher BMI values, due to low motor ability and physical capacity, are able to perform the trials only at the lowest speeds.
This is precisely what happened and, as can be observed in Figure 1, from 2 to 5 $\mathrm{km\cdot h^{-1}}$ the BMI median is around 30 $\mathrm{kg\cdot m^{-2}}$, decreasing to around 27 $\mathrm{kg\cdot m^{-2}}$ at 6 $\mathrm{km\cdot h^{-1}}$, which is the fastest walking speed, with a further reduction to less than 25 $\mathrm{kg\cdot m^{-2}}$ at the running speeds. Furthermore, only one participant with a BMI higher than 30 $\mathrm{kg\cdot m^{-2}}$ was able to run. This implies in a sample size reduction from `r filter(sample_size, acc_placement == "hip" & vector == "resultant" & speed == "2")$pGRF_N` at the slowest speed to `r filter(sample_size, acc_placement == "hip" & vector == "resultant" & speed == "14")$pGRF_N` at the fastest.

\begin{figure}[ht]
	\captionsetup{singlelinecheck = false, format = hang, justification = raggedright, font = footnotesize, labelsep = space}
	\centering
	\begin{measuredfigure}
		\includegraphics[width=\textwidth]{fig1.png}
		\caption{Distribution of participant’s body mass index per speed. Dots represent individual participants.}
	\end{measuredfigure}
\end{figure}

\medskip

As the main variables collected in this experiment are the peak magnitudes and rates of the GRF and ACC signals, there was a need to first establish their relationship. During locomotion, pACC increases linearly as pGRF increases. Such relation can be observed in the Figure 2, Panel A, for from hip-worn accelerometers and the resultant vector, and in Supplemental Figure S1 for all placements and the resultant vector and its vertical component. Moreover, for the same pACC values, the registered pGRF tended to be higher in subjects with higher BMI. It demonstrates that accelerometer data can adequately discriminate between different BMI categories. However, data from the pAR x pLR relationship show a greater dispersion, especially at higher values, and cannot discriminate so well the different BMI categories, as can be observed in Figure 2, Panel B, and Supplemental Figure S2.

\begin{figure}[ht]
	\captionsetup{singlelinecheck = false, format = hang, justification = raggedright, font = footnotesize, labelsep = space}
	\centering
	\begin{measuredfigure}
		\includegraphics[width=\textwidth]{fig2.png}
		\caption{Relationship between variables collected by force plates and accelerometers worn at hip, for the resultant vector. Linear trends for each body mass index category are also depicted. Panel A shows peak magnitudes (pRGRF and pRACC) while Panel B shows peak rates (pRLR and pRAR). Abbreviations: pRACC, peak resultant acceleration; pRAR, peak resultant acceleration rate; pRGRF, peak resultant ground reaction force; pRLR, peak resultant loading rate.}
	\end{measuredfigure}
\end{figure}

\medskip

\newpage

\section*{References}

<div id="refs"></div>

\newpage

\section*{Supplemental Material}

\subsection*{Supplemental Figure S1}
\begin{figure}[ht]
	\captionsetup{singlelinecheck = false, format = hang, justification = raggedright, font = footnotesize, labelsep = space}
	\centering
	\begin{measuredfigure}
		\includegraphics[width=\textwidth]{figS1.png}
	\end{measuredfigure}
\end{figure}
\footnotesize Relationship between peak ground reaction force and acceleration magnitudes. Data from accelerometers worn at ankle (Panels A and D), lower back (Panels B and E) and hip (Panels C and F), for both the resultant vector (Panels A to C) and its vertical component (Panels D to F). Linear trends for each body mass index category are also depicted. Abbreviations: pRACC, peak resultant acceleration; pRGRF, peak resultant ground reaction force; pVACC, peak vertical acceleration; pVGRF, peak vertical ground reaction force.

\medskip

\subsection*{Supplemental Figure S2}
\begin{figure}[ht]
	\captionsetup{singlelinecheck = false, format = hang, justification = raggedright, font = footnotesize, labelsep = space}
	\centering
	\begin{measuredfigure}
		\includegraphics[width=\textwidth]{figS2.png}
	\end{measuredfigure}
\end{figure}
\footnotesize Relationship between peak loading and acceleration rates. Data from accelerometers worn at ankle (Panels A and D), lower back (Panels B and E) and hip (Panels C and F), for both the resultant vector (Panels A to C) and its vertical component (Panels D to F). Linear trends for each body mass index category are also depicted. Abbreviations: pRAR, peak resultant acceleration rate; pRLR, peak resultant loading rate; pVAR, peak vertical acceleration rate; pVLR, peak vertical loading rate.
